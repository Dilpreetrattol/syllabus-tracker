{% extends 'teacher_base.html' %}
{% set active_section = 'subjects' %}
{% block title %}Subject Detail{% endblock %}
{% block teacher_content %}
{% if error %}
  <div class="card" style="padding:24px;color:#b00;font-weight:700;">{{ error }}</div>
{% else %}
<div class="course-header" style="display:flex;align-items:flex-start;justify-content:space-between;gap:28px;flex-wrap:wrap;">
  <div style="flex:1;min-width:320px;">
    <div class="badge">ðŸŽ“ Syllabus & Progress</div>
    <div class="h1" style="margin-top:12px;">{{ subject.code }}: {{ subject.name }}</div>
    <div style="color:var(--t-muted);margin-top:6px;font-weight:600;">Enrolled Students: {{ enroll_count }}</div>
    <div style="margin-top:10px;font-size:14px;color:var(--t-muted);">Progress: <strong>{{ progress_percent }}%</strong> ({{ topics|selectattr('is_completed')|list|length }}/{{ topics|length }} topics)</div>
    <div class="tab-buttons" style="margin-top:18px;display:flex;gap:14px;">
      <button class="tab active" data-target="#tab-syllabus" style="all:unset;background:linear-gradient(180deg,#e64b49,#d33a3a);color:#fff;padding:8px 12px;border-radius:10px;cursor:pointer;transition:all 0.2s;font-weight:700;box-shadow:0 4px 12px rgba(227,66,64,0.3);">Syllabus & Progress</button>
      <button class="tab" data-target="#tab-students" style="all:unset;background:rgba(0,0,0,0.04);padding:8px 12px;border-radius:10px;cursor:pointer;transition:all 0.2s;font-weight:500;">Students</button>
      <button class="tab" data-target="#tab-reports" style="all:unset;background:rgba(0,0,0,0.04);padding:8px 12px;border-radius:10px;cursor:pointer;transition:all 0.2s;font-weight:500;">Reports</button>
    </div>
    <div id="tab-syllabus" class="syllabus-wrap tab-panel" style="margin-top:8px;">
      <div style="display:flex;align-items:center;gap:12px;font-weight:800;color:var(--t-muted);padding-bottom:8px;border-bottom:1px solid rgba(0,0,0,0.04);margin-bottom:12px;">
        <div style="width:40px">#</div>
        <div style="flex:1">Topic</div>
        <div style="width:140px;text-align:right">Status</div>
        <div style="width:70px;text-align:center">Action</div>
      </div>
      {% for t in topics %}
      <div class="syllabus-row" data-topic-id="{{ t.id }}" style="background:{% if t.is_completed %}rgba(0,0,0,0.04){% else %}transparent{% endif %};">
        <div style="width:40px;display:flex;align-items:center;justify-content:center;font-weight:700;">{{ t.order }}</div>
        <div style="flex:1;">
          <div style="font-weight:700">{{ t.name }}</div>
          <div style="color:var(--t-muted);font-size:12px">{{ t.description or 'No description.' }}</div>
        </div>
        <div style="width:140px;text-align:right;font-weight:700;color:var(--t-muted);">
          {% if t.is_completed %}Covered{% else %}Pending{% endif %}
        </div>
        <div style="width:70px;text-align:center;">
          {% if not t.is_completed %}
          <button class="mark-btn" data-id="{{ t.id }}" style="background:var(--t-accent);color:#fff;border:none;padding:6px 10px;border-radius:8px;font-size:12px;cursor:pointer;">Mark</button>
          {% else %}<span style="color:var(--t-accent);font-weight:600;">âœ“</span>{% endif %}
        </div>
      </div>
      {% endfor %}
    </div>

    <div id="tab-students" class="tab-panel" style="display:none;margin-top:8px;">
      {% if enrollments and enrollments|length > 0 %}
      <div style="display:flex;align-items:center;gap:12px;font-weight:800;color:var(--t-muted);padding-bottom:8px;border-bottom:1px solid rgba(0,0,0,0.04);margin-bottom:12px;">
        <div style="flex:1">Student</div>
        <div style="width:220px">Email</div>
        <div style="width:160px">Enrolled At</div>
      </div>
      {% for e in enrollments %}
      <div style="display:flex;align-items:center;gap:12px;padding:10px 8px;border-bottom:1px solid rgba(0,0,0,0.04);">
        <div style="flex:1;font-weight:600;">{{ e.student.name }}</div>
        <div style="width:220px;color:var(--t-muted);">{{ e.student.email }}</div>
        <div style="width:160px;color:var(--t-muted);">{{ e.enrolled_at.strftime('%Y-%m-%d') if e.enrolled_at else '-' }}</div>
      </div>
      {% endfor %}
      {% else %}
      <div class="card" style="padding:16px;">No students enrolled yet.</div>
      {% endif %}
    </div>

    <div id="tab-reports" class="tab-panel" style="display:none;margin-top:8px;">
      <div class="card" style="padding:16px;">
        <div style="font-weight:700;margin-bottom:8px;">Progress Summary</div>
        <div style="color:var(--t-muted);">Overall progress: <strong>{{ progress_percent }}%</strong>. Topics complete: {{ topics|selectattr('is_completed')|list|length }} / {{ topics|length }}.</div>
        <div style="margin-top:12px;">
          <button id="exportCsv" style="background:var(--t-accent);color:#fff;border:none;padding:8px 12px;border-radius:8px;cursor:pointer;">Download CSV Report</button>
        </div>
      </div>
    </div>
  </div>
  <div style="width:260px;">
    <div class="mark-area">
      <div style="font-weight:800;margin-bottom:10px">Bulk Actions</div>
      <button id="bulkCover" style="background:var(--t-accent);color:#fff;border:none;padding:10px 18px;border-radius:24px;font-weight:700;cursor:pointer;">Mark All Covered</button>
      <div style="margin-top:12px;color:var(--t-muted);font-weight:600">Progress {{ progress_percent }}%</div>
    </div>
  </div>
</div>
<script>
// Tab switching
document.querySelectorAll('.tab-buttons .tab').forEach(tab => {
  tab.addEventListener('click', () => {
    document.querySelectorAll('.tab-buttons .tab').forEach(t => {
      t.classList.remove('active');
      t.style.background = 'rgba(0,0,0,0.04)';
      t.style.fontWeight = '500';
      t.style.color = '';
    });
    tab.classList.add('active');
    tab.style.background = 'linear-gradient(180deg,#e64b49,#d33a3a)';
    tab.style.fontWeight = '700';
    tab.style.color = '#fff';
    tab.style.boxShadow = '0 4px 12px rgba(227,66,64,0.3)';
    document.querySelectorAll('.tab-panel').forEach(p => p.style.display = 'none');
    const target = tab.getAttribute('data-target');
    if (target) {
      const el = document.querySelector(target);
      if (el) el.style.display = '';
    }
  });
});



document.querySelectorAll('.mark-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    const id = btn.dataset.id;
    fetch(`/dashboard/teacher/topic/${id}/cover`, {method:'POST'}).then(r=>r.json()).then(data=>{
      if(data.status==='ok') location.reload();
    }).catch(()=>alert('Error marking topic')); });
});
document.getElementById('bulkCover').addEventListener('click', ()=>{
  const pending = Array.from(document.querySelectorAll('.mark-btn'));
  const seq = pending.reduce((p,btn)=> p.then(()=> fetch(`/dashboard/teacher/topic/${btn.dataset.id}/cover`, {method:'POST'}).then(r=>r.json()).then(()=>{})), Promise.resolve());
  seq.then(()=> location.reload());
});

// CSV export for simple report
const exportBtn = document.getElementById('exportCsv');
if (exportBtn) {
  exportBtn.addEventListener('click', () => {
    const rows = [['Order','Topic','Completed']];
    document.querySelectorAll('.syllabus-row').forEach(row => {
      const order = row.querySelector('div').innerText.trim();
      const name = row.querySelector('div:nth-child(2) > div').innerText.trim();
      const completed = row.querySelector('span') ? 'Yes' : (row.querySelector('.mark-btn') ? 'No' : '');
      rows.push([order, name, completed]);
    });
    const csv = rows.map(r => r.map(v => '"'+String(v).replaceAll('"','""')+'"').join(',')).join('\n');
    const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = '{{ subject.code }}_report.csv';
    a.click();
    URL.revokeObjectURL(url);
  });
}
</script>
{% endif %}
{% endblock %}