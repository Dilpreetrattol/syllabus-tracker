{% extends 'teacher_base.html' %}
{% set active_section = 'subjects' %}
{% block title %}Subject Detail{% endblock %}
{% block teacher_content %}
{% if error %}
  <div class="card" style="padding:24px;color:#b00;font-weight:700;">{{ error }}</div>
{% else %}
<div class="course-header" style="display:flex;align-items:flex-start;justify-content:space-between;gap:28px;flex-wrap:wrap;">
  <div style="flex:1;min-width:320px;">
    <div class="badge">ðŸŽ“ Syllabus & Progress</div>
    <div class="h1" style="margin-top:12px;">{{ subject.code }}: {{ subject.name }}</div>
    <div style="color:var(--t-muted);margin-top:6px;font-weight:600;">Enrolled Students: {{ enroll_count }}</div>
    <div style="margin-top:10px;font-size:14px;color:var(--t-muted);">Progress: <strong>{{ progress_percent }}%</strong> ({{ topics|selectattr('is_completed')|list|length }}/{{ topics|length }} topics)</div>
    <div class="tab-buttons" style="margin-top:18px;display:flex;gap:14px;">
      <div class="tab active">Syllabus & Progress</div>
      <div class="tab">Students</div>
      <div class="tab">Reports</div>
    </div>
    <div class="syllabus-wrap">
      <div style="display:flex;align-items:center;gap:12px;font-weight:800;color:var(--t-muted);padding-bottom:8px;border-bottom:1px solid rgba(0,0,0,0.04);margin-bottom:12px;">
        <div style="width:40px">#</div>
        <div style="flex:1">Topic</div>
        <div style="width:140px;text-align:right">Status</div>
        <div style="width:70px;text-align:center">Action</div>
      </div>
      {% for t in topics %}
      <div class="syllabus-row" data-topic-id="{{ t.id }}" style="background:{% if t.is_completed %}rgba(0,0,0,0.04){% else %}transparent{% endif %};">
        <div style="width:40px;display:flex;align-items:center;justify-content:center;font-weight:700;">{{ t.order }}</div>
        <div style="flex:1;">
          <div style="font-weight:700">{{ t.name }}</div>
          <div style="color:var(--t-muted);font-size:12px">{{ t.description or 'No description.' }}</div>
        </div>
        <div style="width:140px;text-align:right;font-weight:700;color:var(--t-muted);">
          {% if t.is_completed %}Covered{% else %}Pending{% endif %}
        </div>
        <div style="width:70px;text-align:center;">
          {% if not t.is_completed %}
          <button class="mark-btn" data-id="{{ t.id }}" style="background:var(--t-accent);color:#fff;border:none;padding:6px 10px;border-radius:8px;font-size:12px;cursor:pointer;">Mark</button>
          {% else %}<span style="color:var(--t-accent);font-weight:600;">âœ“</span>{% endif %}
        </div>
      </div>
      {% endfor %}
    </div>
  </div>
  <div style="width:260px;">
    <div class="mark-area">
      <div style="font-weight:800;margin-bottom:10px">Bulk Actions</div>
      <button id="bulkCover" style="background:var(--t-accent);color:#fff;border:none;padding:10px 18px;border-radius:24px;font-weight:700;cursor:pointer;">Mark All Covered</button>
      <div style="margin-top:12px;color:var(--t-muted);font-weight:600">Progress {{ progress_percent }}%</div>
    </div>
  </div>
</div>
<script>
document.querySelectorAll('.mark-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    const id = btn.dataset.id;
    fetch(`/dashboard/teacher/topic/${id}/cover`, {method:'POST'}).then(r=>r.json()).then(data=>{
      if(data.status==='ok') location.reload();
    }).catch(()=>alert('Error marking topic')); });
});
document.getElementById('bulkCover').addEventListener('click', ()=>{
  const pending = Array.from(document.querySelectorAll('.mark-btn'));
  const seq = pending.reduce((p,btn)=> p.then(()=> fetch(`/dashboard/teacher/topic/${btn.dataset.id}/cover`, {method:'POST'}).then(r=>r.json()).then(()=>{})), Promise.resolve());
  seq.then(()=> location.reload());
});
</script>
{% endif %}
{% endblock %}